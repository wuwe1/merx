---
name: 错误处理和退出码
status: open
created: 2026-02-04T02:46:28Z
updated: 2026-02-04T02:51:33Z
github: https://github.com/wuwe1/merx/issues/10
depends_on: [3]
parallel: true
conflicts_with: []
---

# Task: 错误处理和退出码

## 描述

实现友好的错误消息和标准化退出码，确保 CI/CD 集成和脚本使用的可靠性。

## 验收标准

- [ ] Mermaid 语法错误显示行号和位置
- [ ] 错误消息包含修复建议
- [ ] 退出码符合规范：0=成功, 1=解析错误, 2=文件未找到, 3=选项无效, 4=写入错误
- [ ] 错误输出到 stderr，正常输出到 stdout
- [ ] --silent 标志抑制非错误输出

## 技术细节

### 退出码定义
```typescript
// src/utils/errors.ts
export const ExitCode = {
  SUCCESS: 0,
  PARSE_ERROR: 1,
  FILE_NOT_FOUND: 2,
  INVALID_OPTIONS: 3,
  WRITE_ERROR: 4
} as const

export class MerxError extends Error {
  constructor(
    message: string,
    public code: number,
    public hint?: string
  ) {
    super(message)
  }
}
```

### 错误格式化
```typescript
export function formatError(error: unknown): string {
  if (error instanceof MerxError) {
    let msg = `Error: ${error.message}`
    if (error.hint) {
      msg += `

Hint: ${error.hint}`
    }
    return msg
  }

  // Mermaid 解析错误
  if (isMermaidError(error)) {
    return formatMermaidError(error)
  }

  return `Error: ${String(error)}`
}

function formatMermaidError(error: MermaidParseError): string {
  const { line, column, message, source } = error

  // 显示错误位置
  const lines = source.split('
')
  const context = lines.slice(Math.max(0, line - 2), line + 1)
  const pointer = ' '.repeat(column) + '^^^'

  return `
Error: Invalid Mermaid syntax at line ${line}
${context.join('
')}
${pointer}

${message}
`.trim()
}
```

### 统一错误处理
```typescript
// src/cli.ts
process.on('uncaughtException', (error) => {
  console.error(formatError(error))
  process.exit(error instanceof MerxError ? error.code : 1)
})
```

## 依赖

- [ ] 任务 002 完成（render 命令基础）
- [ ] beautiful-mermaid 错误类型

## 工作量估算

- 规模：S
- 小时数：2-3
- 并行：true

## 完成定义

- [ ] 所有退出码正确返回
- [ ] 错误消息友好
- [ ] 解析错误显示位置
- [ ] stderr/stdout 分离正确
