---
name: 批量渲染
status: open
created: 2026-02-04T02:46:28Z
updated: 2026-02-04T02:51:33Z
github: https://github.com/wuwe1/merx/issues/7
depends_on: [3, 4]
parallel: true
conflicts_with: []
---

# Task: 批量渲染

## 描述

实现 glob 模式支持和 --outdir 标志，支持批量渲染多个 Mermaid 文件。

## 验收标准

- [ ] `merx render *.mmd` 渲染所有匹配文件
- [ ] `merx render docs/**/*.mmd` 支持递归 glob
- [ ] `--outdir ./images` 输出到指定目录
- [ ] 输出文件保持相对路径结构
- [ ] 显示渲染进度和结果摘要
- [ ] 部分文件失败不中断整体流程

## 技术细节

### glob 处理
```typescript
// src/utils/input.ts
import fg from 'fast-glob'

export async function resolveInputFiles(pattern: string): Promise<string[]> {
  // 检查是否是 glob 模式
  if (fg.isDynamicPattern(pattern)) {
    const files = await fg(pattern, { onlyFiles: true })
    if (files.length === 0) {
      throw new Error(`No files match pattern: ${pattern}`)
    }
    return files
  }

  // 单个文件
  return [pattern]
}
```

### 批量渲染逻辑
```typescript
// src/commands/render.ts
async function renderBatch(
  files: string[],
  outdir?: string,
  options: RenderOptions
): Promise<BatchResult> {
  const results: Result[] = []

  for (const file of files) {
    try {
      const content = await fs.readFile(file, 'utf-8')
      const svg = await renderMermaid(content, options)

      const outPath = outdir
        ? path.join(outdir, file.replace(/\.mmd$/, '.svg'))
        : file.replace(/\.mmd$/, '.svg')

      await fs.mkdir(path.dirname(outPath), { recursive: true })
      await fs.writeFile(outPath, svg)

      results.push({ file, status: 'success', output: outPath })
    } catch (error) {
      results.push({ file, status: 'error', error })
    }
  }

  return { results, success: results.filter(r => r.status === 'success').length }
}
```

### 进度显示
```typescript
console.log(`Rendering ${files.length} files...`)
// 渲染每个文件后
console.log(`✓ ${file} → ${outPath}`)
// 最终摘要
console.log(`
✅ ${success}/${total} files rendered`)
```

## 依赖

- [ ] 任务 002 完成（render 命令）
- [ ] 任务 003 完成（输出处理）
- [ ] fast-glob 依赖

## 工作量估算

- 规模：M
- 小时数：3-4
- 并行：true（与 005 可并行）

## 完成定义

- [ ] glob 模式工作
- [ ] --outdir 工作
- [ ] 进度显示清晰
- [ ] 错误处理不中断
