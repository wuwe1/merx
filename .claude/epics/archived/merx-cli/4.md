---
name: stdin/stdout 支持
status: open
created: 2026-02-04T02:46:28Z
updated: 2026-02-04T02:51:33Z
github: https://github.com/wuwe1/merx/issues/4
depends_on: [3]
parallel: false
conflicts_with: []
---

# Task: stdin/stdout 支持

## 描述

实现管道输入检测和输出路由，支持 `echo "graph LR; A-->B" | merx render` 和 stdout 输出。

## 验收标准

- [ ] `echo "graph LR; A-->B" | merx render` 输出 SVG 到 stdout
- [ ] `echo "graph LR; A-->B" | merx render --ascii` 输出 ASCII 到 stdout
- [ ] `merx render diagram.mmd`（无 -o）自动输出到 `diagram.svg`
- [ ] stdin 输入无 -o 时输出到 stdout
- [ ] 正确检测 TTY vs 管道输入

## 技术细节

### stdin 检测
```typescript
// src/utils/input.ts
export async function readInput(file?: string): Promise<string> {
  if (file) {
    return fs.readFile(file, 'utf-8')
  }

  if (!process.stdin.isTTY) {
    // 从 stdin 读取
    return readStdin()
  }

  throw new Error('No input provided')
}

async function readStdin(): Promise<string> {
  const chunks: Buffer[] = []
  for await (const chunk of process.stdin) {
    chunks.push(chunk)
  }
  return Buffer.concat(chunks).toString('utf-8')
}
```

### 输出路由
```typescript
// src/utils/output.ts
export async function writeOutput(
  content: string,
  output?: string,
  inputFile?: string,
  format: 'svg' | 'ascii' = 'svg'
): Promise<void> {
  if (format === 'ascii' || (!output && !inputFile)) {
    process.stdout.write(content)
    return
  }

  const outPath = output || inputFile?.replace(/\.mmd$/, '.svg')
  await fs.writeFile(outPath, content)
}
```

## 依赖

- [ ] 任务 002 完成（render 命令基础）

## 工作量估算

- 规模：S
- 小时数：2-3
- 并行：false（需要先有 render 命令）

## 完成定义

- [ ] stdin 管道输入工作
- [ ] stdout 输出工作
- [ ] 自动文件命名工作
- [ ] TTY 检测正确
